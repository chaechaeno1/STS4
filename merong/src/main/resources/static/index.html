<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>RESTFUL API í…ŒìŠ¤íŠ¸</title>
    <style>
        * {
            box-sizing: border-box;
        }

        #wrapper {
            text-align: center;
        }

        #list {
            width: 70%;
            height: 400px;
            border: 5px solid rgb(166, 0, 255);
            overflow: auto;
        }

        #toolbar {
            width: 70%;
            border: 5px solid orange;
            padding-bottom: 5%;

            /*height: 50px;*/
        }

        div {
            margin: 0 auto;
            min-width: 400px;
        }

        input[type=button] {
            /* ì•„ë˜ë¡œ 9px ì´ë™ í¬ê¸° 1.3ë°° */
            transform: translateY(9px) scale(1.3);
        }

        #muTable {
            margin: 0 auto;
        }
    </style>
</head>

<body>
    <div id="wrapper">
        <h1>RESTFUL API í…ŒìŠ¤í†µ</h1>
        <div id="list"></div>
        <div id="toolbar">
            <br>
            <form>
                <table id="muTable">
                    <tr>
                        <td>ë„˜</td>
                        <td><input type="text" name="sujinNum" value=""></td>
                    </tr>
                    <tr>
                        <td>ì´ë¦„</td>
                        <td><input type="text" name="sujinName" value=""></td>
                    </tr>
                    <tr>
                        <td>ë‚´ìš©</td>
                        <td><input type="text" name="sujinContent" value=""></td>
                    </tr>
                    <tr>
                        <td>íŒŒì¼</td>
                        <td><input type="text" name="sujinFile" value=""></td>
                    </tr>
                    <tr>
                        <td>íŒŒì¼ì„ íƒ</td>
                        <td><input type="file" myFile multiple name="sujinFile2" value=""></td>
                        <!-- ë””ë ‰í† ë¦¬ í†µì§¸ë¡œ ì˜¬ë¦¬ë ¤ë©´ directory(ì˜ ì“°ì§„ ì•ŠìŒ), ì—¬ëŸ¬ê°œëŠ” multiple -->
                    </tr>
                </table>
            </form>
            <div id="merong">

            </div>
            <input type="button" value="ì…ë ¥" onclick="fPostInput()">&nbsp;&nbsp;
            <input type="button" value="ìˆ˜ì •" onclick="fPutUpdate()">&nbsp;&nbsp;
            <input type="button" value="ì‚­ì œ" onclick="fDeleteDel()">&nbsp;&nbsp;
            <input type="button" value="íŒŒì¼ì—…" onclick="fFileUp()">&nbsp;&nbsp;
            <input type="button" value="jQíŒŒì¼ì—…" onclick="jQFileUp()">&nbsp;&nbsp;
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>

    <script>
        const merong = document.querySelector("#merong");
        const sujinFile2 = document.querySelector("[myFile]");

        // íŒŒì¼ ì „ì†¡ì€ ë¬´ì¡°ê±´ postë¡œ ì „ì†¡!
        function jQFileUp() {
            console.log("í•­ìƒ ì²´í¬:", sujinFile2.files); //ëˆˆìœ¼ë¡œ í™•ì¸!

            //ì•„ì‘ìŠ¤ë¡œ íŒŒì¼ ë³´ë‚¼ ë• FormDataê°€ í•„ìš”!
            let formData = new FormData(); //ì „ì†¡ë°©ì‹ì´ ë¬´ì¡°ê±´ multipart/form-data
            formData.append("mc", sujinFile2.files[0]);

            //jQueryëŠ” defaultê°€ contentTypeì„ application/x-www-form-urlencoded ë¡œ ì§€ì •í•˜ê¸° ë•Œë¬¸ì—...
            //defaultê°’ì„ process(í›„ì²˜ë¦¬)
            $.ajax({
                type:"post",
                url:"/api/sfile",
                contentType:false, //íŒŒì¼ ì „ì†¡ì‹œ í•„ìˆ˜
                processData:false, //íŒŒì¼ ì „ì†¡ì‹œ í•„ìˆ˜
                cache:false,       //ì´ê±´ ì˜µì…˜, ì „ì†¡ ìºì‰¬X
                data:formData,
                dataType:"text", //íŒŒì¼ê²½ë¡œë§Œ ë°›ì•„ì˜¤ë¯€ë¡œ text, ì¤‘ê´„í˜¸ ëŒ€ê´„í˜¸ê°€ ì—†ìœ¼ë©´ ë¬´ì¡°ê±´ textë¼ê³  ìƒê°!
                success:function(rslt){
                    console.log("ì²´í¬ :", rslt);
                    let $img = $("<img>");
                    $img.attr("src",rslt);
                    $img.css("width","100px").css("height","100px").css("display","block");

                    let $aTag = $("<a>");
                    $aTag.attr("href",rslt);
                    $aTag.html("ë¯¼ì±„ë‹¤ìš´ë¡œë“œ");
                    //ğŸ’¥ğŸ’¥ í•œê°€ì§€ ì£¼ì˜!! Cross-Origin ì œì•½ì‚¬í•­ ìˆìŒ
                    let pathArr = rslt.split("/");
                    $aTag.attr("download",pathArr[pathArr.length - 1]); //ë§ˆì§€ë§‰êº¼

                    console.log("ì²´í¬ :",$img);
                    console.log("ì²´í¬ :",$aTag[0]);
                    merong.appendChild($img[0]); // í™”ë©´ì— ë¶™ì—¬ë„£ê¸°
                    merong.appendChild($aTag[0]); // í™”ë©´ì— ë¶™ì—¬ë„£ê¸°

                    //ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ëˆ„ë¥´ìë§ˆì ë°”ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ê²Œ í•˜ë ¤ë©´??
                    $aTag.click(); //ê·¸ëƒ¥ í´ë¦­ (ì´ê±´ ì¥ë‚œ~)
                }
            })   


        }





        // íŒŒì¼ ì „ì†¡ì€ ë¬´ì¡°ê±´ postë¡œ ì „ì†¡!
        function fFileUp() {
            console.log("í•­ìƒ ì²´í¬:", sujinFile2.files); //ëˆˆìœ¼ë¡œ í™•ì¸!

            //ì•„ì‘ìŠ¤ë¡œ íŒŒì¼ ë³´ë‚¼ ë• FormDataê°€ í•„ìš”!
            let formData = new FormData(); //ì „ì†¡ë°©ì‹ì´ ë¬´ì¡°ê±´ multipart/form-data
            formData.append("mc", sujinFile2.files[0]);

            let xhr = new XMLHttpRequest();
            xhr.open("post", "/api/sfile", true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    console.log("ì²´í¬ :", xhr.responseText);
                    let img = document.createElement("img");
                    img.src = xhr.responseText;
                    img.width = 100; img.height = 100;
                    img.style.display = "block"; // ì˜†ì— ì•„ë¬´ë„ ëª»ì˜¤ê²Œ!, í˜¼ì í•œ ì¤„!

                    let aTag = document.createElement("a");
                    aTag.href = xhr.responseText;
                    aTag.innerHTML = "ë¯¼ì±„ë‹¤ìš´ë¡œë“œ";
                    //ğŸ’¥ğŸ’¥ í•œê°€ì§€ ì£¼ì˜!! Cross-Origin ì œì•½ì‚¬í•­ ìˆìŒ
                    //ë‚´ ì„œë²„ì— ìˆëŠ” ê²ƒë§Œ ë‹¤ìš´ë¡œë“œê°€ ë˜ê³ , ë‹¤ë¥¸ ì‚¬ì´íŠ¸ê»€ ì•ˆë¨!(ì°½ì´ ì—´ë¦¼)
                    //(ë¬¸ì œ) ì›ë˜ íŒŒì¼ëª…ì„ ì£¼ë ¤ë©´?
                    //aTag.download = "ì˜ˆì›ì¡¸ë¦¼.jpg";
                    //aTag.download = aTag.href; // http___localhost_8017_mcimg_82EC902.jpg
                    //aTag.download = xhr.responseText; //_mcimg_ì‚¬ì2.jpg
                    let pathArr = xhr.responseText.split("/");
                    aTag.download = pathArr[pathArr.length - 1]; //ë§ˆì§€ë§‰êº¼

                    merong.appendChild(img); // í™”ë©´ì— ë¶™ì—¬ë„£ê¸°
                    merong.appendChild(aTag); // í™”ë©´ì— ë¶™ì—¬ë„£ê¸°

                    //ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ëˆ„ë¥´ìë§ˆì ë°”ë¡œ ë‹¤ìš´ë¡œë“œ ë°›ê²Œ í•˜ë ¤ë©´??
                    aTag.click(); //ê·¸ëƒ¥ í´ë¦­ (ì´ê±´ ì¥ë‚œ~)
                }
            }
            xhr.send(formData);
        }






        const myForm = document.forms[0];
        const myList = document.querySelector("#list");

        // ê¸°ëŠ¥ í•¨ìˆ˜
        // í…Œì´ë¸” TR ìš”ëŸ°ê±´ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ê²Œ ì¢‹ìŒ
        const fTrClickMouseOverOut = () => {
            let trs = document.querySelectorAll("tr");
            for (let i = 0; i < trs.length; i++) {
                trs[i].addEventListener("mouseover", () => {
                    trs[i].style.backgroundColor = "black";
                    trs[i].style.color = "orange";
                });

                trs[i].addEventListener("mouseout", function () {
                    this.style.backgroundColor = "white";
                    this.style.color = "black";
                    this.style.fontWeight = "normal";
                });
            }
        }

        // í…Œì´ë¸” ë§¹ê·¸ëŠ” í•¨ìˆ˜
        const fMakeTable = (sujins) => {
            let tableStr = `<table border=1 style="width:100%"><tbody>`;
            tableStr += `<tr><th>Num</th><th>Name</th><th>Content</th><th>File</th></tr>`;
            for (let i = 0; i < sujins.length; i++) {
                let sujin = sujins[i];
                tableStr += `<tr onclick="fGetOne(${sujin.sujinNum})">`;
                tableStr += `<td>${sujin.sujinNum}</td>`;
                tableStr += `<td>${sujin.sujinName}</td>`;
                tableStr += `<td>${sujin.sujinContent}</td>`;
                tableStr += `<td>${sujin.sujinFile}</td>`;
                tableStr += `</tr>`;
            }
            tableStr += `<tr></tbody></table>`;
            myList.innerHTML = tableStr;

            //í…Œì´ë¸”ì´ ë™ì ìœ¼ë¡œ ìƒˆë¡œ ë§¹ê¸€ì–´ì§€ë¯€ë¡œ, TRì´ë²¤íŠ¸ë„ ê·¸ë•Œë§ˆë‹¹
            fTrClickMouseOverOut();
        }


        // ë°±ì—”ë“œ Restful SujinControllerì— ëŒ€ì‘í•˜ëŠ” í•¨ìˆ˜ë“¤
        // getìœ¼ë¡œ list(sujins)ê°€ì ¸ì˜¤ê¹…
        const fGetList = () => {
            $.ajax({
                type: "get",
                url: "/api/sujins",
                //data : // ë³´ë‚¼ ë°ì´í„°ëŠ” ì—†ìŒ
                dataType: "json", //ë¦¬ìŠ¤íŠ¸ë¥¼ ê°ì²´ë¡œ ëŒë ¤ë°›ì„ ë•Œ json
                success: function (rslt) {
                    console.log("í•­ìƒ ê²°ê³¼ í™•ì¸:", rslt);
                    fMakeTable(rslt);
                }
            })
        }
        fGetList(); // ê·¸ëƒ¥ ë°”ë¡œ ë¦¬ìŠ¤íŠ¸ ì½œ!



        // getìœ¼ë¡œ 1ê°œ row(sujin) ê°€ì ¸ì˜¤ê¹…
        const fGetOne = (sujinNum) => {
            $.ajax({
                type: "get",
                url: `/api/sujins/${sujinNum}`,
                dataType: "json", //VOëŠ” MAPìœ¼ë¡œ ê°€ì ¸ì˜´, ê°ì²´ ì•„ë‹ˆë©´ textë¡œë„ ì“°ê¸°ë„í•¨
                success: function (rslt) {
                    console.log("ê²°ê³¼:", rslt);
                    //formì— ì¶œë ¥
                    myForm.sujinNum.value = rslt.sujinNum;
                    myForm.sujinName.value = rslt.sujinName;
                    myForm.sujinContent.value = rslt.sujinContent;
                    myForm.sujinFile.value = rslt.sujinFile;
                }
            })

        }


        //ğŸ’¥ íŒŒì¼ ìˆì„ ë•Œ ë³´ë‚´ëŠ” insert
        // postë¡œ insert 1ê°œ row(sujin) 
        const fPostInput = () => {
            //ì•„ì‘ìŠ¤ íŒŒì¼ ì „ì†¡ì‹œ ë¬´ì¡°ê±´ FormData í•„ìš”, ì „ì†¡ ì¸ì½”ë”© ë°©ì‹ë¬¸ì œ!!!!

            let formData = new FormData(); //ë§¤ê°œë³€ìˆ˜ë¡œ formê°ì²´ë¥¼ ì£¼ë©´ ìë™ìœ¼ë¡œ ì…ë ¥
            formData.append("sujinName",myForm.sujinName.value);
            formData.append("sujinContent",myForm.sujinContent.value);
            formData.append("sujinFile2",myForm.sujinFile2.files[0]);

            //formDataì— ë“¤ì–´ìˆëŠ” ê°’ ëˆˆìœ¼ë¡œ í™•ì¸
            for(let [key, value] of formData){
                console.log("ì²´í¬(í‚¤ë°¸ë¥˜) :", key, value);
            }


            $.ajax({
                type: "post",
                url: "/api/sujins",
                contentType:false, //í•„ìˆ˜
                processData:false, //í•„ìˆ˜
                cache:false, // ì˜µì…˜
                data: formData, // ë¬¸ìì—´(ì‹œë¦¬ì–¼ë¼ì´ì¦ˆ)í™” í•˜ë©´ ì•ˆë¨!
                dataType: "text", //ëŒì•„ì˜¤ëŠ” ê°’ì´ ë‹¨ìˆœ ìˆ«ì!!  ì…ë ¥, ìˆ˜ì •, ì‚­ì œëŠ” ìˆ«ìë§Œ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì— json.parse í•˜ë©´ ì•ˆë¨!
                success: function (rslt) {
                    console.log("ê²°ê³¼: ", rslt);
                    if (rslt == 1) {
                        alert("ì •ë§ ì˜ ì…ë ¥ë˜ì—ˆì–´ìš”!");
                        //tríƒœê·¸ë§Œ í•œê°œ ë§Œë“¤ì–´ì„œ ì¶”ê°€í•˜ê±°ë‚˜,..
                        //ë¦¬ìŠ¤íŠ¸ í˜¸ì¶œí•˜ê±°ë‚˜..
                        fGetList(); //ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¿Œë¦¬ê¸°

                        setTimeout(() => { //ë³€ì¹™ í…Œí¬ë‹‰
                            myList.scrollTo(0, myList.scrollHeight); //ìŠ¤í¬ë¡¤ ëìœ¼ë¡œ ë‚´ë¦¬ê¸°!
                        }, 50)
                    }
                }

            })


        }




/*  íŒŒì¼ ì—†ì´ ë³´ë‚¼ ë•Œ !!      
        // postë¡œ insert 1ê°œ row(sujin) 
        const fPostInput = () => {

            let sujinVO = {
                //sujinNum : //ìë™ ì‹œí€€ìŠ¤ ìƒì„±ì´ë¼ í•„ìš”ì—†ìŒ
                sujinName: myForm.sujinName.value,
                sujinContent: myForm.sujinContent.value,
                sujinFile: myForm.sujinFile.value
            }

            console.log("sujinVO : ", sujinVO); //í•­ìƒ ëˆˆìœ¼ë¡œ ê°’ì´ ì˜ ë“¤ì–´ê°”ëŠ”ì§€ ì²´í¬!

            $.ajax({
                type: "post",
                url: "/api/sujins",
                contentType: "application/json;charset=UTF-8", //jsoní˜•ì‹ ë¬¸ìì—´ ë³´ëƒ„ì„ í‘œì‹œ
                data: JSON.stringify(sujinVO), //ê°ì²´ë¥¼ ê·¸ëƒ¥ ë„˜ê¸°ë©´ ì•ˆë¨!!!!!!
                dataType: "text", //ëŒì•„ì˜¤ëŠ” ê°’ì´ ë‹¨ìˆœ ìˆ«ì!!  ì…ë ¥, ìˆ˜ì •, ì‚­ì œëŠ” ìˆ«ìë§Œ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì— json.parse í•˜ë©´ ì•ˆë¨!
                success: function (rslt) {
                    console.log("ê²°ê³¼: ", rslt);
                    if (rslt == 1) {
                        alert("ì •ë§ ì˜ ì…ë ¥ë˜ì—ˆì–´ìš”!");
                        //tríƒœê·¸ë§Œ í•œê°œ ë§Œë“¤ì–´ì„œ ì¶”ê°€í•˜ê±°ë‚˜,..
                        //ë¦¬ìŠ¤íŠ¸ í˜¸ì¶œí•˜ê±°ë‚˜..
                        fGetList(); //ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë¿Œë¦¬ê¸°

                        setTimeout(() => { //ë³€ì¹™ í…Œí¬ë‹‰
                            myList.scrollTo(0, myList.scrollHeight); //ìŠ¤í¬ë¡¤ ëìœ¼ë¡œ ë‚´ë¦¬ê¸°!
                        }, 50)
                    }
                }

            })


        }
 */


        // ì°¸ê³  postInputì„ jqury $.ajaxë¡œ ê³ ì¹œë‹¤ë©´ 
        const fPostInput2 = () => {
            let sujinVO = JSON.stringify({
                //			sujinNum : myForm.sujinNum.value,  // sequence ì“°ë¯€ë¡œ í•„ìš”ì—†ìŒ
                sujinName: myForm.sujinName.value,
                sujinContent: myForm.sujinContent.value,
                sujinFile: myForm.sujinFile.value,
            });

            $.ajax({
                type: "post",
                url: "/api/sujin",
                contentType: "application/json;charset=utf-8",
                dataType: "text",
                data: sujinVO,
                success: function (rslt) {
                    console.log("í•­ìƒë¨¼ì €í™”ê¹…:", rslt);
                    let rowCnt = rslt;
                    if (rowCnt != 0) {
                        alert("ì˜ ì¶”ê°€ ë˜ì—ˆë‹¤ë„¤ìš©");
                        fGetList();  // ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¹…, ì¼ë¶€ë ?(ë‹¤ë¥¸ë°©ë²•ì€?)
                        console.log("ì²´í‚:", myList.scrollHeight);

                        //ê·¸ë ¤ì§€ê³  ìˆëŠ”ë™ì•ˆ(Renderingì¤‘)ì— ì›€ì§ì´ë©´ ìª¼ë©” ëª¨ìë¼ê²Œ ë¨)
                        setTimeout(() => {
                            myList.scrollTo(0, myList.scrollHeight);
                        }, 30);
                    }
                }
            })
        }

        // putìœ¼ë¡œ update ìˆ˜ì • ë¶€ë¥´ê¹…
        const fPutUpdate = () => {
            let sujinVO = JSON.stringify({
                sujinNum: myForm.sujinNum.value, //í•´ë‹¹ ë²ˆí˜¸ê°€ í•„ìš”í•˜ë¯€ë¡œ ê°’ì„ ë„˜ê²¨ì•¼ í•¨
                sujinName: myForm.sujinName.value,
                sujinContent: myForm.sujinContent.value,
                sujinFile: myForm.sujinFile.value,
            });

            $.ajax({
                type: "put",
                url: "/api/sujins",
                contentType: "application/json;charset=UTF-8",
                data: JSON.stringify(sujinVO),
                dataType: "text",
                success: function (rslt) {
                    console.log("ì²´í¬: ", rslt);
                    if (rslt == 1) {
                        alert("ì˜ ìˆ˜ì •ë˜ì—ˆì–´ìš”~!");
                        fGetList(); //ìƒˆë¡œê³ ì¹¨
                    }
                }
            })

        }

        // delete ë©”ì†Œë“œë¡œ ìš”ì²­í•´ì„œ ì§€ìš°ê¹…
        const fDeleteDel = () => {
            let seqNum = myForm.sujinNum.value;

            $.ajax({
                type: "delete",
                url: `/api/sujins/${seqNum}`,
                dataType: "text",
                success: function (rslt) {
                    if (rslt == 1) {
                        alert("ì˜ ì§€ì›Œì¡Œì–´ìš”~!");
                        fGetList();
                    }
                }
            })

        }
    </script>
</body>

</html>